{% extends "_base.html" %}
{% block content %}

<script language="javascript" type="text/javascript">
    var stdlimit = 10;
    var currPage = 1;
    var edit_count = 0;

    $(document).ready(function() {
        refresh_table(0,stdlimit);
    });

    function refresh_table(offset,limit){
        $.get('/question_list_table',{offset:offset,limit:limit},
            function(data){
            $('#questListForm').html(data);});
    }

    function refresh_table_default(){
        refresh_table(0,stdlimit);
    }

    function load_page(page){
        currPage = page;
        refresh_table((page-1)*stdlimit,stdlimit);
    }

    function reload(){
        load_page(currPage);
    }

    function edit_field(id){        
        var elem = $('#question_' + id + ' a');
        var time_elem = $('#time_'+id);
        if (elem.hasClass('activated')){
            return;
        }
        var text = elem.text();
        var time = time_elem.text();
        elem.addClass('activated');
        elem.text('');
        elem.hide();
        time_elem.text('');
        var edit_field = $('<input type="text" class="input-block-level" placeholder="your question">').val(text);
        var time_field = $('<input type="number" size="3" maxlength="3" placeholder="sec">').val(time);

        var editelem = $('#sedit_'+id);
        edit_count++;
        
        editelem.click(function(){            
            edit_count--;
            $('#edit_'+id).show();
            $('#sedit_'+id).hide();
            
            var newTime = time_field.val();
            edit_question(id,edit_field.val(),newTime);

            var newText = elem.val();
            elem.text(newText);
            elem.removeClass('activated');

            time_elem.text(newTime);
            
            $(time_field).remove();
            $(edit_field).remove();
            $('#sedit_'+id).unbind('click');
        });
        $('#sedit_'+id).show();
        editelem.css('color', '');
        editelem.css('font-weight', 'normal');

        $('#edit_'+id).hide();
        
        edit_field.blur(function() {
            editelem.css('color', 'darkorange');
            editelem.css('font-weight', 'bold');
        });
        
        edit_field.appendTo(elem.parent());
        time_field.appendTo(time_elem);
        edit_field.focus();
    }

    function edit_question(id,text,time){
        $.getJSON("/edit_question",{id:id,text:text,time:time},
        function(data){
            if(data.check){                
                $('#question_'+id).html('<a href=\"/filteranswers/'+data.id+'\">'+data.text+'</a>');
                $('#time_'+id).html(data.time)
            }
            else{
                $('#error').html("Error while editing question question.");
            }
        });
    }
	
	var advanced_visible = false;
	function advanced(){
		if (advanced_visible) {
			$('.comment-field').hide();
			$('.tags-field').hide();
			$('.rating-field').hide();
		} else {
			$('.comment-field').show();
			$('.tags-field').show();
			$('.rating-field').show();
		}
		advanced_visible = !advanced_visible;
    }
	
    function delete_question(id){
        $.getJSON("/delete_question/"+id,{},
        function(data){
            if (data.deleted)
                $('#row_'+id).remove();
            else
                $('#error').html("Error while deleting question.");
        });
    }

    function toggle_review_options(id, type){
        $.getJSON("/togglequestion",{id:id, type:type},
        function(data){
            if(data.check){
                if(!data.toggle){
                    $('input[name='+type+''+id+']').attr('checked', false);
                }
                else{
                    $('input[name='+type+''+id+']').attr('checked', true);
                }
            }
            else{
                $('#error').html("Error while togging question question.");
            }
        });
    }

    function toggle_state(id, type){
    answerable = "False"
    reviewable = "False"
    archived = "False"
    $.getJSON("/togglequestion",{id:id, type:type},
    function(data){
      if(data.check){
        if(type == "Answerable"){
          answerable="True";
          $('#q'+id+'_drop1').hide();
          $('#q'+id+'_drop2').show();
          $('#q'+id+'_drop3').show();
        }
        if(type == "Reviewable"){
          reviewable="True";
          $('#q'+id+'_drop2').hide();
          $('#q'+id+'_drop1').show();
          $('#q'+id+'_drop3').show();
        }
        if(type == "Archived"){
          archived="True";
          $('#q'+id+'_drop3').hide();
          $('#q'+id+'_drop1').show();
          $('#q'+id+'_drop2').show();
        }
        $('#state'+id).html(type);
      }
      else{
        $('#error').html("Error while togging question question.");
      }
    });    
    }

    function add_question(){
        $('#addQ').hide()
        $('#cancelQ').show()       
        $('#qList tr:last').after(
        '<tr>\
			<td class="question-field"><input id="qtext" type="text" class="input-block-level" name="question" placeholder="your question"></td> \
			<td class="time-field"><input id="qtime" type="number" name="time" size="3" maxlength="3" placeholder="sec"></td> \
			<td class="state-field"><label class="checkbox"><input id="qact" type="checkbox" name="active">Answerable</label></td> \
			<td class="comment-field"><input id="qcomm" type="checkbox" name="comment" checked></td> \
			<td class="tags-field"><input id="qtag" type="checkbox" name="tags" checked></td> \
			<td class="rating-field"><input id="qrat" type="checkbox" name="rating" checked></td> \
			<td colspan=3><input id="save_question" type="submit" onclick=save_question() class="btn btn-block btn-primary" value="Add Question"></td>\
		</tr>');
		if (!advanced_visible) {
			$('.comment-field').hide();
			$('.tags-field').hide();
			$('.rating-field').hide();
		}
        $('#qtext').focus();
        
        if (edit_count > 0) {
            alert("You have "+edit_count+" open edits, that still need to be submitted.");
        }
    }
    
    function cancel_question(){
        $('#cancelQ').hide()
        $('#addQ').show()        
        $('#qList tr:last').remove()        
    }

    function save_question(){
		$('#save_question').attr('disabled', 'disabled')
        activev = ($('#qact').is(':checked') ? true : false);
        commentv = ($('#qcomm').is(':checked') ? true : false);
        tagsv = ($('#qtag').is(':checked') ? true : false);
		ratingv = ($('#qrat').is(':checked') ? true : false);
        timev = $('#qtime').val();
        questionv = $('#qtext').val();

        $.post('/handle_question',{active:activev,comment:commentv,tags:tagsv,
                question:questionv,time:timev,rating:ratingv},
                function(data){
                    reload()
					$('#save_question').attr('disabled', '')
                    $('#cancelQ').hide()
					$('#addQ').show()                    
                });
				
        return false;
    }

</script>

<div id="error" style="background-color: #a33; color: white;"></div>
<div id="questListForm" style="display:block">

</div>
{% endblock %}
